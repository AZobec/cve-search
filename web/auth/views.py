from flask import redirect, request, render_template
from flask_login import logout_user, login_required, login_user

from lib.Authentication import AuthenticationHandler
from lib.User import User
from . import auth
from .forms import LoginForm, RegistrationForm
from ..home.utils import adminInfo, defaultFilters
from ..run import login_manager

auth_handler = AuthenticationHandler()


@login_manager.user_loader
def load_user(id):
    return User.get(id, auth_handler)


@auth.route("/login", methods=["GET", "POST"])
def login():

    form = LoginForm()

    if form.validate_on_submit():

        # validate username and password
        username = request.form.get("username")
        password = request.form.get("password")
        person = User.get(username, auth_handler)
        if person and person.authenticate(password):
            defaultFilters.update(
                {
                    "blacklistSelect": "on",
                    "whitelistSelect": "on",
                    "unlistedSelect": "show",
                }
            )
            login_user(person)
            return render_template("admin.html", status="logged_in", **adminInfo())
        else:
            return render_template("login.html", form=form, status="wrong_user_pass")
    else:
        return render_template("login.html", form=form)


@auth.route("/register", methods=["GET", "POST"])
def register():

    form = RegistrationForm()
    if form.validate_on_submit():

        pass

    else:
        return render_template("register.html", form=form)


@auth.route("/logout")
@login_required
def logout():
    logout_user()
    return redirect("/")
