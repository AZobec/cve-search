{% extends 'layouts/master-page' %}
{% block title %}Most recent entries{% endblock %}
{% block head %}
<!-- css -->
<link href="/static/css/custom/filter.css" rel="stylesheet" />
<link href="/static/css/dataTables.bootstrap4.min.css" rel="stylesheet" />

<!-- javascript -->
<script type="text/javascript" src="/static/js/custom/filter.js"></script>
<script type="text/javascript" src="/static/js/jquery.dataTables.min.js"></script>
<script type="text/javascript" src="/static/js/dataTables.bootstrap4.min.js"></script>
<script type="text/javascript">
    $(document).ready(function(){
      setFilters();
      {% if errors %}
        setStatus("An error occured while parsing the filters. Please verify the input fields, like the dates", "danger");
      {% endif %}
    })
    function setFilters(){
      {% if filters is defined %}
        {% for key, val in filters.items() %}
          if($("#{{key}}").is(":checkbox")){
            if("{{val}}" === "on"){$("#{{key}}").prop('checked', true);}
          }else{
            $("#{{key}}").val("{{val}}");
          }
        {% endfor %}
        cvssSelectDisable()
        timeSelectDisable()
      {%endif%}
    }
  </script>
{% endblock %}
{% block content %}
<!-- Filter options -->
{% include 'subpages/filters.html' %}
<!-- Search results -->
{% include 'subpages/table.html' %}
{% endblock %}

{% block body_scripts %}
<script>
function ConvertDateTime(datetimestring) {

  var date = new Date(datetimestring)

  return date.toISOString().substring(0, 10) + ' - ' + date.toTimeString().substring(0, 5);
}
</script>
<script>
  $(document).ready(function() {
       $('#CVEs').DataTable({
           "processing": true,
           "serverSide": true,
           "ajax": {
               "url": "/fetch_cve_data",
               "data": function ( d ) {
                   d.retrieve = "cves";
               },
               "type": "POST"
           },
           "columnDefs": [
             { "searchable": false, "targets": 0 }
           ],
           "columns": [
               { "data": "blank",
                   render : function(data, type, row) {
                  return ''
               }
               },
               { "data": "id" ,
                   render : function(data, type, row) {
                  return '<a href="/cve/'+ row['id'] + '" width="20" height="20" title="Active">'+ row['id'] +'</a>'
               }
               },
               { "data": "cvss" },
               { "data": "summary" },
               { "data": "last-modified" ,
                   render : function(data, type, row) {
                 var dtg = ConvertDateTime(row['last-modified'])
                 return dtg
               }
               },
               { "data": "Published",
                   render : function(data, type, row) {
                 var dtg = ConvertDateTime(row['Published'])
                 return dtg
               }
               },
           ],
           "iDisplayLength": 10,
           "language": { "processing": "<img src='{{ url_for('static', filename='img/ajaxload.gif') }}'> Loading...",
               "zeroRecords": "No records to display", searchPlaceholder: "Regex search...", search: ""},
           stateSave: true,
           "search": {
               "regex": true
           }
       });
       $('#CVEs').removeClass('d-none');
  } );
</script>
{% endblock %}