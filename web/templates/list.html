<!doctype html>
<html lang="en">
<head>
  <title>{{ listType }} management</title>
  <!-- defaults -->
  {% include 'defaultHead.html' %}
  <!-- javascript -->
  <script type="text/javascript">
    var editedCPE
    function addItem(cpetype) {
      var CPE, commentArray, keyword;
      var comments = "";
      if(cpetype == "cpe"){
        CPE = document.getElementById("cpeid").value.trim();
        commentArray = document.getElementById("cpecomments").value.trim();
      }else{
        CPE = document.getElementById("keywordid").value.trim();
        commentArray = document.getElementById("keywordcomments").value.trim();
        cpetype = document.getElementById("keyword").value.trim();
      }
      if (commentArray){
        commentArray = commentArray.split("\n");
        for (comment in commentArray){
          comments = comments + "# " + commentArray[comment];
        }
      }
      CPE = CPE+comments;
      if(editedCPE){
        var url ="/admin/{{ listType|lower }}/edit";
        postURL(url, CPE, cpetype);
      }else{
        $.getJSON('/admin/addToList', {
          list:'{{ listType|lower }}', cpe:CPE, type:cpetype
        }, function(data) {
          showStatus(data);
          fillTable(data);
        });
      }
    }
    function showStatus(data){
      $("#status").removeClass();
      $("#status_icon").removeClass();
      if(data['status'][1] =='success'){
        $("#status").addClass("alert alert-success");
        $("#status_icon").addClass("glyphicon glyphicon-ok-sign");
      }else if (data['status'][1] =='info'){
        $("#status").addClass("alert alert-info");
        $("#status_icon").addClass("glyphicon glyphicon-info-sign");
      }else if (data['status'][1] =='warning'){
        $("#status").addClass("alert alert-warning");
        $("#status_icon").addClass("glyphicon glyphicon-warning-sign");
      }else if (data['status'][1] =='error'){
        $("#status").addClass("alert alert-danger");
        $("#status_icon").addClass("glyphicon glyphicon-remove-sign");
      }
      $("#status_message").empty();
      if(data['status'][0] =='added'){
        $("#status_message").append("Rule added to the "+data["listType"]);
      }else if(data['status'][0] == 'removed'){
        $("#status_message").append("Rule removed from the "+data["listType"]);
      }else if(data['status'][0] == 'updated'){
        $("#status_message").append("The rule was updated");
      }else if(data['status'][0] == 'update_failed'){
        $("#status_message").append("Failed to update the rule in the "+data["listType"]);
      }else if(data['status'][0] == 'already_exists'){
        $("#status_message").append("This rule or a more global rule already exists in the "+data["listType"]);
      }else if(data['status'][0] == 'already_removed'){
        $("#status_message").append("Rule was already removed from the "+data["listType"]);
      }else if(data['status'][0] == 'uinvalid_url'){
        $("#status_message").append("Invalid URL!");
      }
      $("#status").removeTemporaryClass("hidden", 3000);
    }
    function fillTable(data){
      var rules=data['rules'];
      $("#cpes > tbody > tr").remove();
      $("#keywords > tbody > tr").remove();
      var line = "";
      for (i=0;i<rules.length;i++){
        //First td
        line += "<tr><td><a href='javascript:remove(\""+rules[i]['id']+"\")'><span class='glyphicon glyphicon-remove'></span></a></td>";
        //Second td
        if('comments' in rules[i]){
          line += "<td><a href='javascript:editCPE('"+rules[i]['id']+"',"+rules[i]['comments']+")'><span class='glyphicon glyphicon-edit'></span></a></td>";
        }else{
          line += "<td><a href='javascript:editCPE('"+rules[i]['id']+"',[])'><span class='glyphicon glyphicon-edit'></span></a></td>";
        }
        //Third td
        line += "<td>"+rules[i]['id']+"</td>";
        //Possible fourth td
        if(rules[i]['type']!='cpe'){
          if(rules[i]['type'] == 'targethardware'){
            line += "<td>Target Hardware</td>";
          }else if (rules[i]['type'] == 'targetsoftware'){
            line += "<td>Target Software</td>";
          }
        }
        //last td
        line += "<td><ul>";
        if('comments' in rules[i]){
          for (j=0;j<rules[i]['comments'].length;j++){
            line += "<li>"+rules[i]['comments'][j]+"</li>";
          }
        }
        line += "</ul></td></tr>";
        if(rules[i]['type']=='cpe'){
          $("#cpes > tbody").append(line);
        }else{
          $("#keywords > tbody").append(line);
        }
        line="";
      }
    }

    function remove(item){
      if(confirm("Are you sure you want to remove this rule?")){
        $.getJSON('/admin/removeFromList', {
          list:'{{ listType|lower }}',
          cpe:item
        }, function(data) {
          showStatus(data);
          fillTable(data);
        });
      }
    }
    function postURL(url, cpe, cpetype) {
      var form = document.createElement("FORM");
      form.method = "POST";
      form.style.display = "none";
      document.body.appendChild(form);
      form.action = url
      input = document.createElement("INPUT");
      input.type = "hidden";
      input.name = "cpe"
      input.value = cpe
      form.appendChild(input);
      input2 = document.createElement("INPUT");
      input2.type = "hidden";
      input2.name = "type"
      input2.value = cpetype
      form.appendChild(input2);
      if(editedCPE){
        oldCPE = document.createElement("INPUT");
        oldCPE.type = "hidden";
        oldCPE.name = "oldCPE";
        oldCPE.value = editedCPE;
        form.appendChild(oldCPE);
      }
      form.submit();
    }
    function editCPE(cpe, comments){
      editedCPE = cpe;
      commentString="";
      for(comment in comments){
        commentString = commentString + comments[comment] + "\n";
      }
      commentString = commentString.trim();
      document.getElementById("id").value = cpe;
      document.getElementById("comments").value = commentString;
      document.getElementById("add").value = "Update";
      if(document.getElementById("cancel") == null){
        input = document.createElement("INPUT");
        input.type = "button";
        input.addEventListener("click", cancel, false);
        input.id = "cancel";
        input.value = "Cancel";
        document.getElementById("addItem").appendChild(input);
      }
    }
    function cancel(){
      document.getElementById('id').value = '';
      document.getElementById('comments').value = '';
      document.getElementById('add').value = 'Add';
      document.getElementById('addItem').removeChild(document.getElementById('cancel'));
    }
  </script>
</head>

<body>
  <div class="container-fluid">
    <div class="row">
      <div class="col-sm-12">
        <!-- Nav -->
        {% include 'menu.html' %}
        <!-- End Nav -->
        <!-- Content -->
        <div>
          <!-- breadcrumb -->
          <ol class="breadcrumb">
            <li><a href="/admin">Admin</a></li>
            <li class="active">{{listType}}</li>
          </ol>
          <!-- add items -->
          <!-- Status -->
          <div id="status" class="hidden">
            <span id="status_icon"></span>
            <div id="status_message"></div>
          </div>
          <!-- Add new rule -->
          <div class="well well-small">
            <table class="table"><tr><td class="listInput">
              <form id="addItem" class="nav form-search" onsubmit="addItem('cpe'); return false;">
                <strong>Add an item to the {{ listType }}</strong> <br />
                <input id="cpeid" type="text" placeholder="full or partial CPE" pattern="(cpe:/|cpe:2.3:)[a-z0-9/.:%-_~]+" /> <br />
                <textarea id="cpecomments" rows="4" placeholder="comments, separated by enter"></textarea> <br />
                <input id="add" type="submit" value="Add"/>
              </form>
              <a href="/admin/listmanagement">Browse...</a>
            </td><td class="listInputCenter">
              <p>or</p>
            </td><td class="listInput">
              <form id="addItem" class="nav form-horizontal" onsubmit="addItem('-'); return false;">
                <strong>Add CPE keywords to the {{ listType }}</strong> <br />
                  <div>
                    <select class="form-control" id="keyword">
                      <option value="targetsoftware">Target Software</option>
                      <option value="targethardware">Target Hardware</option>
                    </select>
                    <input id="keywordid" type="text" class="form-control" placeholder="Target Software/Hardware Name">
                  </div>
                <textarea id="keywordcomments"rows="4" placeholder="comments, separated by enter"></textarea> <br />
                <input id="add" type="submit" value="Add"/>
              </form>
            </td></tr></table>
          </div>
          <!-- Current rules -->
          {% set rulesList = rules|list %}
          <table class="table table-even">
            <tr>
              <td>
                <b>CPE Rules</b>
                <table id="cpes" class="table table-hover table-striped table-condensed">
                  <thead><tr class="warning"><td></td><td></td><td>Rule</td><td>Comments</td></tr></thead>
                  <tbody>
                    {% for ruleID in rulesList if ruleID['type']=='cpe' %}
                      <tr>
                        <td><a href="javascript:remove('{{ruleID['id']}}')"><span class="glyphicon glyphicon-remove"></span></a></td>
                        {% if ruleID['comments'] is defined %}
                          <td><a href='javascript:editCPE("{{ruleID["id"]|htmlEncode}}",{{ruleID["comments"]}})'><span class="glyphicon glyphicon-edit"></span></a></td>
                        {% else %}
                          <td><a href='javascript:editCPE("{{ruleID["id"]|htmlEncode}}",[])'><span class="glyphicon glyphicon-edit"></span></a></td>
                        {% endif %}
                        <td>{{ ruleID['id'] }}</td>
                        <td>
                          <ul>
                            {% for comment in ruleID['comments'] %}
                              <li>{{ comment }}</li>
                            {% endfor %}
                          </ul>
                        </td>
                      </tr>
                    {% endfor %}
                  </tbody>
                </table>
              </td>
              <td>
                <b>Keywords</b>
                <table id="keywords" class="table table-hover table-striped table-condensed">
                  <thead><tr class="warning"><td></td><td></td><td>Rule</td><td>Keyword</td><td>Comments</td></tr></thead>
                  <tbody>
                    {% for ruleID in rulesList if ruleID['type']!='cpe' %}
                      <tr>
                        <td><a href="javascript:remove('{{ruleID['id']}}')"><span class="glyphicon glyphicon-remove"></span></a></td>
                        {% if ruleID['comments'] is defined %}
                          <td><a href='javascript:editCPE("{{ruleID["id"]|htmlEncode}}",{{ruleID["comments"]}})'><span class="glyphicon glyphicon-edit"></span></a></td>
                        {% else %}
                          <td><a href='javascript:editCPE("{{ruleID["id"]|htmlEncode}}",[])'><span class="glyphicon glyphicon-edit"></span></a></td>
                        {% endif %}
                        <td>{{ ruleID['id'] }}</td>
                        <td>
                          {% if ruleID['type'] == 'targethardware' %}
                            Target Hardware
                          {% elif ruleID['type'] == 'targetsoftware' %}
                            Target Software
                          {% endif %}
                        </td>
                        <td>
                          <ul>
                            {% for comment in ruleID['comments'] %}
                              <li>{{ comment }}</li>
                            {% endfor %}
                          </ul>
                        </td>
                      </tr>
                    {% endfor %}
                  </tbody>
                </table>
              </td>
            </tr>
          </table>
          <a href="#" class="back-to-top">Back to Top</a>
        </div>
        <!-- end content -->
      </div>
    </div>
  </div>
</body>
</html>
