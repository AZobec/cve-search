<!doctype html>
<html lang="en">
<head>
  <title>{{ listType }} management</title>
  <!-- defaults -->
  {% include 'defaultHead.html' %}
  <!-- javascript -->
  <script type="text/javascript">
    var editedCPE
    function addItem(cpetype) {
      var CPE
      var commentArray
      var keyword
      var comments = ""
      if(cpetype == "cpe"){
        CPE = document.getElementById("cpeid").value.trim();
        commentArray = document.getElementById("cpecomments").value.trim();
      }else{
        CPE = document.getElementById("keywordid").value.trim();
        commentArray = document.getElementById("keywordcomments").value.trim();
        cpetype = document.getElementById("keyword").value.trim();
      }
      if (commentArray){
        commentArray = commentArray.split("\n");
        for (comment in commentArray){
          comments = comments + "# " + commentArray[comment];
        }
      }
      CPE = CPE+comments;
      if(editedCPE){
        var url ="/admin/{{ listType|lower }}/edit";
      }else{
        var url ="/admin/{{ listType|lower }}/add";
      }
      postURL(url, CPE, cpetype);
    }
    function remove(item){
      if(confirm("Are you sure you want to remove this rule?")){
        var url = "/admin/{{ listType|lower }}/remove";
        postURL(url,item);
      }
    }
    function postURL(url, cpe, cpetype) {
      var form = document.createElement("FORM");
      form.method = "POST";
      form.style.display = "none";
      document.body.appendChild(form);
      form.action = url
      input = document.createElement("INPUT");
      input.type = "hidden";
      input.name = "cpe"
      input.value = cpe
      form.appendChild(input);
      input2 = document.createElement("INPUT");
      input2.type = "hidden";
      input2.name = "type"
      input2.value = cpetype
      form.appendChild(input2);
      if(editedCPE){
        oldCPE = document.createElement("INPUT");
        oldCPE.type = "hidden";
        oldCPE.name = "oldCPE";
        oldCPE.value = editedCPE;
        form.appendChild(oldCPE);
      }
      form.submit();
    }
    function editCPE(cpe, comments){
      editedCPE = cpe;
      commentString="";
      for(comment in comments){
        commentString = commentString + comments[comment] + "\n";
      }
      commentString = commentString.trim();
      document.getElementById("id").value = cpe;
      document.getElementById("comments").value = commentString;
      document.getElementById("add").value = "Update";
      if(document.getElementById("cancel") == null){
        input = document.createElement("INPUT");
        input.type = "button";
        input.addEventListener("click", cancel, false);
        input.id = "cancel";
        input.value = "Cancel";
        document.getElementById("addItem").appendChild(input);
      }
    }
    function cancel(){
      document.getElementById('id').value = '';
      document.getElementById('comments').value = '';
      document.getElementById('add').value = 'Add';
      document.getElementById('addItem').removeChild(document.getElementById('cancel'));
    }
  </script>
</head>

<body>
  <div class="container-fluid">
    <div class="row">
      <div class="col-sm-12">
        <!-- Nav -->
        {% include 'menu.html' %}
        <!-- End Nav -->
        <!-- Content -->
        <div>
          <!-- breadcrumb -->
          <ol class="breadcrumb">
            <li><a href="/admin">Admin</a></li>
            <li class="active">{{listType}}</li>
          </ol>
          <!-- add items -->
          <!-- Status -->
          <div>
            <!-- type -->
            {% if status[1] == 'success' %}
              <div class="alert alert-success">
                <span class="glyphicon glyphicon-ok-sign"></span>
            {% elif status[1] == 'info' %}
              <div class="alert alert-info">
                <span class="glyphicon glyphicon-info-sign"></span>
            {% elif status[1] == 'warning' %}
              <div class="alert alert-warning">
                <span class="glyphicon glyphicon-warning-sign"></span>
            {% elif status[1] == 'error' %}
              <div class="alert alert-danger">
                <span class="glyphicon glyphicon-remove-sign"></span>
            {% else %}
              <div>
            {% endif %}
              <!-- content -->
              {% if (status[0] == 'added') %}
                Rule added to the {{ listType }}
              {% elif status[0] == 'removed' %}
                Rule removed from the {{ listType }}
              {% elif (status[0] == 'updated') %}
                The rule was updated
              {% elif (status[0] == 'update_failed') %}
                Failed to update the rule in the {{ listType }}
              {% elif (status[0] == 'already_exists') %}
                This rule or a more global rule already exists in the {{ listType }}
              {% elif (status[0] == 'already_removed') %}
                Rule was already removed from the {{ listType }}.
              {% elif (status[0] == 'invalid_url') %}
                Invalid URL!
              {% endif %}
              {% if (status[0] != 'default') %}
                <br /><br /><a href="/admin/{{listType|lower}}/view"><span class="glyphicon glyphicon-remove"></span> close</a>
              {% endif %}
              </div>
          </div>
          <!-- Add new rule -->
          <div class="well well-small">
            <table class="table"><tr><td class="listInput">
              <form id="addItem" class="nav form-search" onsubmit="addItem('cpe'); return false;">
                <strong>Add an item to the {{ listType }}</strong> <br />
                <input id="cpeid" type="text" placeholder="full or partial CPE" pattern="(cpe:/|cpe:2.3:)[a-z0-9/.:%-_~]+" /> <br />
                <textarea id="cpecomments" rows="4" placeholder="comments, separated by enter"></textarea> <br />
                <input id="add" type="submit" value="Add"/>
              </form>
              <a href="/admin/listmanagement">Browse...</a>
            </td><td class="listInputCenter">
              <p>or</p>
            </td><td class="listInput">
              <form id="addItem" class="nav form-horizontal" onsubmit="addItem('-'); return false;">
                <strong>Add CPE keywords to the {{ listType }}</strong> <br />
                  <div>
                    <select class="form-control" id="keyword">
                      <option value="targetsoftware">Target Software</option>
                      <option value="targethardware">Target Hardware</option>
                    </select>
                    <input id="keywordid" type="text" class="form-control" placeholder="Target Software/Hardware Name">
                  </div>
                <textarea id="keywordcomments"rows="4" placeholder="comments, separated by enter"></textarea> <br />
                <input id="add" type="submit" value="Add"/>
              </form>
            </td></tr></table>
          </div>
          <!-- Current rules -->
          {% set rulesList = rules|list %}
          <table class="table table-even">
            <tr>
              <td>
                <b>CPE Rules</b>
                <table class="table table-hover table-striped table-condensed">
                  <tbody>
                    <tr class="warning">
                      <td></td>
                      <td></td>
                      <td>Rule</td>
                      <td>Comments</td>
                    </tr>
                    {% for ruleID in rulesList if ruleID['type']=='cpe' %}
                      <tr>
                        <td><a href="javascript:remove('{{ruleID['id']|htmlEncode}}')"><span class="glyphicon glyphicon-remove"></span></a></td>
                        {% if ruleID['comments'] is defined %}
                          <td><a href='javascript:editCPE("{{ruleID["id"]|htmlEncode}}",{{ruleID["comments"]}})'><span class="glyphicon glyphicon-edit"></span></a></td>
                        {% else %}
                          <td><a href='javascript:editCPE("{{ruleID["id"]|htmlEncode}}",[])'><span class="glyphicon glyphicon-edit"></span></a></td>
                        {% endif %}
                        <td>{{ ruleID['id'] }}</td>
                        <td>
                          <ul>
                            {% for comment in ruleID['comments'] %}
                              <li>{{ comment }}</li>
                            {% endfor %}
                          </ul>
                        </td>
                      </tr>
                    {% endfor %}
                  </tbody>
                </table>
              </td>
              <td>
                <b>Keywords</b>
                <table class="table table-hover table-striped table-condensed">
                  <tbody>
                    <tr class="warning">
                      <td></td>
                      <td></td>
                      <td>Rule</td>
                      <td>Keyword</td>
                      <td>Comments</td>
                    </tr>
                    {% for ruleID in rulesList if ruleID['type']!='cpe' %}
                      <tr>
                        <td><a href="javascript:remove('{{ruleID['id']|htmlEncode}}')"><span class="glyphicon glyphicon-remove"></span></a></td>
                        {% if ruleID['comments'] is defined %}
                          <td><a href='javascript:editCPE("{{ruleID["id"]|htmlEncode}}",{{ruleID["comments"]}})'><span class="glyphicon glyphicon-edit"></span></a></td>
                        {% else %}
                          <td><a href='javascript:editCPE("{{ruleID["id"]|htmlEncode}}",[])'><span class="glyphicon glyphicon-edit"></span></a></td>
                        {% endif %}
                        <td>{{ ruleID['id'] }}</td>
                        <td>
                          {% if ruleID['type'] == 'targethardware' %}
                            Target Hardware
                          {% elif ruleID['type'] == 'targetsoftware' %}
                            Target Software
                          {% endif %}
                        </td>
                        <td>
                          <ul>
                            {% for comment in ruleID['comments'] %}
                              <li>{{ comment }}</li>
                            {% endfor %}
                          </ul>
                        </td>
                      </tr>
                    {% endfor %}
                  </tbody>
                </table>
              </td>
            </tr>
          </table>

          <a href="#" class="back-to-top">Back to Top</a>
        </div>
        <!-- end content -->
      </div>
    </div>
  </div>
</body>
</html>
