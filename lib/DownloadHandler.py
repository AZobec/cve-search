import threading
from abc import ABC, abstractmethod
from concurrent.futures.thread import ThreadPoolExecutor

import requests

from lib.DatabaseLayer import bulkUpdate

thread_local = threading.local()


class DownloadHandler(ABC):

    def __init__(self):
        pass

    def __repr__(self):
        """ return string representation of object """
        return "<< DownloadHandler:{} >>"

    def get_session(self):
        if not hasattr(thread_local, "session"):
            thread_local.session = requests.Session()
        return thread_local.session

    def process_downloads(self, sites):
        with ThreadPoolExecutor(max_workers=8) as executor:
            executor.map(self.download_site, sites)

    def chunk_list(self, lst, number):
        """Yield successive n-sized chunks from lst."""
        for i in range(0, len(lst), number):
            yield lst[i:i + number]

    def process_chunks_in_function(self, function, chunks):
        with ThreadPoolExecutor(max_workers=10) as executor:
            executor.map(function, chunks)

    @abstractmethod
    def download_site(self, **kwargs):
        pass

    @abstractmethod
    def stream_json(self, **kwargs):
        pass

    @abstractmethod
    def update(self, **kwargs):
        pass

    @abstractmethod
    def populate(self, **kwargs):
        pass
