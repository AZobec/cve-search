#!/usr/bin/env python3
# -*- coding: utf-8 -*-
#
# Database
#  The database specific code.
#
# Software is free software released under the "Modified BSD license"
#
# Copyright (c) 2017       Pieter-Jan Moreels - pieterjan.moreels@gmail.com

# Imports
import pymongo
import sys

from lib.Objects   import CPE
from lib.Singleton import Singleton

# Code
class Database(metaclass=Singleton):
  def __init__(self, host=None, port=None, db=None, user=None,
               password=None):
    kwargs = {}
    if host:     kwargs['host']=    host
    if port:     kwargs['port']=    port
    if db:       kwargs['db']=      db
    if user:     kwargs['user']=    user
    if password: kwargs['password']=password
    self.db = self.getConnection(**kwargs)
    #self.db = self.getConnection()

    self.colCVE=             self.db['cves']
    self.colCPE=             self.db['cpe']
    self.colCWE=             self.db['cwe']
    self.colCPEOTHER=        self.db['cpeother']
    self.colWHITELIST=       self.db['mgmt_whitelist']
    self.colBLACKLIST=       self.db['mgmt_blacklist']
    self.colUSERS=           self.db['mgmt_users']
    self.colINFO=            self.db['info']
    self.colRANKING=         self.db['ranking']
    self.colVIA4=            self.db['via4']
    self.colCAPEC=           self.db['capec']
    self.colPlugSettings=    self.db['plugin_settings']
    self.colPlugUserSettings=self.db['plugin_user_settings']

  ###############################
  # Database Specific Functions #
  ###############################
  def getConnection(self, host='127.0.0.1', port=27017, db='cvedb',
                    user=None, password=None):
    try:
      if user and password:
        mongoURI = "mongodb://{user}:{pwd}@{host}:{port}/{db}".format(
                    user     = urllib.parse.quote( user ),
                    password = urllib.parse.quote( password ),
                    host = host, port = port, db = db)
        connect = pymongo.MongoClient(mongoURI)
      else:
        connect = pymongo.MongoClient(host, port)[db]
    except Exception as e:
      print(e)
      sys.exit("Unable to connect to Mongo. Is it running on %s:%s?"%(host, port))
    return connect

  def sanitize(self, x):
    if type(x)==pymongo.cursor.Cursor:
      x=list(x)
    if type(x)==list:
      for y in x: sanitize(y)
    if x and  "_id" in x: x.pop("_id")
    return x


  #######################
  # Blacklist/Whitelist #
  #######################
  # Info
  def blacklist_size(self):
    return self.colBLACKLIST.count()

  def witelist_size(self):
    return self.colWHITELIST.count()

  def blacklist_contains(self, cpe):
    return True if self.colBLACKLIST.find({'id': cpe}).count()>0 else False

  def whitelist_contains(self, cpe):
    return True if self.colWHITELIST.find({'id': cpe}).count()>0 else False

  # Data manipulation
  def blacklist_insert(self, cpe, type, comments=None):
    data = {'id': cpe, 'type': type}
    if comments: data['comments'] = comments
    self.colBLACKLIST.insert(data)

  def whitelist_insert(self, cpe, type, comments=None):
    data = {'id': cpe, 'type': type}
    if comments: data['comments'] = comments
    self.colWHITELIST.insert(data)

  def blacklist_remove(self, cpe):
    self.colBLACKLIST.remove({'id': cpe})

  def whitelist_remove(self, cpe):
    self.colWHITELIST.remove({'id': cpe})

  def blacklist_update(self, cpeOld, cpeNew, cpeType, comments=None):
    data = {'id': cpeNew, 'type': cpeType}
    if comments: data['comments'] = comments
    self.colBLACKLIST.update({'id': cpeOld}, data)

  def whitelist_update(self, cpeOld, cpeNew, cpeType, comments=None):
    data = {'id': cpeNew, 'type': cpeType}
    if comments: data['comments'] = comments
    self.colWHITELIST.update({'id': cpeOld}, data)

  def blacklist_drop(self):
    self.colBLACKLIST.drop()

  def whitelist_drop(self):
    self.colWHITELIST.drop()

  # Data retrieval
  def blacklist_get(self):
    return self.sanitize(self.colBLACKLIST.find())

  def whitelist_get(self):
    return self.sanitize(self.colWHITELIST.find())


  #########
  # Users #
  #########
  # Info
  def user_size(self):
    return self.colUSERS.count()

  # Data manipulation
  def user_add(self, entry):
    self.colUSERS.insert(entry)

  def user_update(self, entry):
    self.colUSERS.update({'username': entry['username']}, entry)

  def user_remove(self, user):
    self.colUSERS.remove({'username': user})

  def user_setAdmin(self, user, admin=True):
    if admin:
      self.colUSERS.update({'username': user}, {'$set': {'master': True}})
    else:
      self.colUSERS.update({'username': user}, {'$unset': {'master': ""}})

  def user_setLocalOnly(self, user, localOnly=True):
    if localOnly:
      self.colUSERS.update({'username': user}, {'$set': {'local_only': True}})
    else:
      self.colUSERS.update({'username': user}, {'$unset': {'local_only': ""}})

  # Data retrieval
  def user_get(self, user):
    return self.sanitize(self.colUSERS.find_one({"username": user}))

  def user_getAll(self):
    return self.sanitize(self.colUSERS.find())

  def user_isOnlyAdmin(self, user):
    return True if len(list(self.colUSERS.find({"username": {"$ne": user}, "master": True}))) == 0 else False


  ########
  # CVEs #
  ########
  # Data manipulation
  def upsertCVE(self, data):
    if type(data) is dict: data = [data]
    if len(data)>0:
      bulk=self.colCVE.initialize_unordered_bulk_op()
      for x in data:
        bulk.find({'id': x['id']}).upsert().update({'$set': x})
      bulk.execute()

  # Data retrieval
  def getCVE(self, id):
    return sanitize(col.find_one({"id": id}))

  def cvesForCPE(cpe):
    if not cpe: return []
    return self.sanitize(self.colCVE.find({"vulnerable_configuration": {"$regex": cpe}}).sort("Modified", -1))


  def getCVEs(limit=False, query=[], skip=0, cves=None, collection=None):
    col=colCVE if not collection else db[collection]
    if type(query) == dict: query=[query]
    if type(cves) == list: query.append({"id": {"$in": cves}})
    if len(query) == 0:
      cve=col.find().sort("Modified", -1).limit(limit).skip(skip)
    elif len(query)  == 1:
      cve=col.find(query[0]).sort("Modified", -1).limit(limit).skip(skip)
    else:
      cve=col.find({"$and": query}).sort("Modified", -1).limit(limit).skip(skip)
    return sanitize(cve)


  ########
  # CPEs #
  ########
  # Data modification
  def cpe_upsert(self, data):
    if type(data) is CPE: data = [data]
    if len(data)>0:
      bulk=self.colCPE.initialize_unordered_bulk_op()
      for x in data:
        if type(x) is CPE:
          bulk.find({'id': x.id}).upsert().update({'$set': x.dict()})
      bulk.execute()

  # Data retrieval
  def cpe_get(self, id):
    return CPE.fromJson(self.sanitize(self.colCPE.find_one({"id": id})))

  def cpe_getAll(self):
    return [CPE.fromJson(x) for x in self.sanitize(self.colCPE.find())]


  ########
  # CWEs #
  ########
  def cwe_upsert(self, data):
    if type(data) is dict: data = [data]
    if len(data)>0:
      bulk=self.colCWE.initialize_unordered_bulk_op()
      for x in data:
        bulk.find({'id': x['id']}).upsert().update({'$set': x})
      bulk.execute()


  ########
  # Info #
  ########
  def _getInfo(self, collection):
    return self.sanitize(self.colINFO.find_one({'db': collection.name}))

  def _setUpdate(self, collection):
    self.colINFO.update({"db": collection.name},
                        {"$set": {"last-modified": date}}, upsert=True)

  def _getColUpdate(self, collection):
    info = self._getInfo(collection)
    return info.get('last-modified') if info else None

  # CVE
  def cve_info(self):
    return self._getInfo(self.colCVE)

  def cve_setUpdate(self, date):
    self._setUpdate(self.colCVE)

  def cve_getUpdate(self):
    return self._getUpdate(self.colCVE)

  # CPE
  def cpe_info(self):
    return self._getInfo(self.colCPE)

  def cpe_setUpdate(self, date):
    self._setUpdate(self.colCPE)

  def cpe_getUpdate(self):
    return self._getUpdate(self.colCPE)

  # CWE
  def cwe_info(self):
    return self._getInfo(self.colCWE)

  def cwe_setUpdate(self, date):
    self._setUpdate(self.colCWE)

  def cwe_getUpdate(self):
    return self._getUpdate(self.colCWE)

