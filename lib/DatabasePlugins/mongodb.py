import urllib

import bson
import pymongo
from pymongo import DESCENDING, ASCENDING
from pymongo.collection import Collection

from lib.DatabasePluginBase import DatabasePluginBase
from lib.Config import Configuration

config = Configuration()


HOST = config.readSetting("Database", "Host", config.default["mongoHost"])
PORT = config.readSetting("Database", "Port", config.default["mongoPort"])
DATABASE = config.getMongoDB()
USERNAME = urllib.parse.quote(
    config.readSetting("Database", "Username", config.default["mongoUsername"])
)
PASSWORD = urllib.parse.quote(
    config.readSetting("Database", "Password", config.default["mongoPassword"])
)


class MongoPlugin(DatabasePluginBase):
    def __init__(self):
        """
        Custom MongoDBPlugin
        """
        super().__init__()

        if USERNAME and PASSWORD:
            mongoURI = "mongodb://{username}:{password}@{host}:{port}/{db}".format(
                username=USERNAME, password=PASSWORD, host=HOST, port=PORT, db=DATABASE,
            )
        else:
            mongoURI = "mongodb://{host}:{port}/{db}".format(
                host=HOST, port=PORT, db=DATABASE
            )

        connect = pymongo.MongoClient(mongoURI, connect=False)
        self.connection = connect[DATABASE]

        for each in self.connection.list_collection_names():
            setattr(
                self,
                "store_{}".format(each),
                Collection(database=self.connection, name=each),
            )

    def create_schema(self, **kwargs):
        pass

    def count(self, retrieve, dict_filter={}):
        """
        Method for retrieving a document count

        :param retrieve: Collection to retrieve the count from
        :type retrieve: str
        :param dict_filter: dict representing a filter see pyMongo doc
        :type dict_filter: dict
        :return: Count
        :rtype: int
        """
        return getattr(self, "store_{}".format(retrieve)).count_documents(filter=dict_filter)

    def query_docs(
        self,
        retrieve=None,
        dict_filter={},
        sort=None,
        limit=None,
        skip=0,
        query_filter=None,
        sort_dir="DESC",
        id_to_string=True,
    ):
        """
        Method used to perform a extended query against the database in order to fetch documents.

        :param retrieve: Collection name where to retrieve the documents from
        :type retrieve: str
        :param dict_filter: dict representing a filter see pyMongo doc
        :type dict_filter: dict
        :param sort: Field to sort on or list of tuples of field and direction
                    [("field", pymongo.DESCENDING), ("field2", pymongo.DESCENDING)]
        :type sort: list
        :param limit: Can be used to limit the amount of returned results
        :type limit: int
        :param skip: Can be used to skip the first x records of the returned results
        :type skip: int
        :param query_filter: Dict to include fields to return in the query results (e.g.: {field1: 1, field2: 1})
        :type query_filter: dict
        :param sort_dir: DESC (default) for DESCENDING, ASC for ASCENDING
        :type sort_dir: str
        :param id_to_string: Whether to convert mongodb '_id' from an ObjectId to a string
        :type id_to_string: bool
        :return: List of documents saved in the backend
        :rtype: list
        """
        documentlist = []

        if sort is not None:
            if isinstance(sort, str):
                if sort_dir == "DESC":
                    if limit is not None:
                        resultset = (
                            getattr(self, "store_{}".format(retrieve))
                            .find(dict_filter, {"json": 0})
                            .sort(sort, DESCENDING)
                            .limit(limit)
                            .skip(skip)
                        )
                    else:
                        resultset = (
                            getattr(self, "store_{}".format(retrieve))
                            .find(dict_filter, {"json": 0})
                            .sort(sort, DESCENDING)
                            .skip(skip)
                        )
                elif sort_dir == "ASC":
                    if limit is not None:
                        resultset = (
                            getattr(self, "store_{}".format(retrieve))
                            .find(dict_filter, {"json": 0})
                            .sort(sort, ASCENDING)
                            .limit(limit)
                            .skip(skip)
                        )
                    else:
                        resultset = (
                            getattr(self, "store_{}".format(retrieve))
                            .find(dict_filter, {"json": 0})
                            .sort(sort, ASCENDING)
                            .skip(skip)
                        )
            if isinstance(sort, list):
                if limit is not None:
                    resultset = (
                        getattr(self, "store_{}".format(retrieve))
                        .find(dict_filter, {"json": 0})
                        .sort(sort)
                        .limit(limit)
                        .skip(skip)
                    )
                else:
                    resultset = (
                        getattr(self, "store_{}".format(retrieve))
                        .find(dict_filter, {"json": 0})
                        .sort(sort)
                        .skip(skip)
                    )
        else:
            if limit is not None:
                resultset = (
                    getattr(self, "store_{}".format(retrieve))
                    .find(dict_filter, {"json": 0})
                    .limit(limit)
                    .skip(skip)
                )
            else:
                resultset = (
                    getattr(self, "store_{}".format(retrieve))
                    .find(dict_filter, {"json": 0})
                    .skip(skip)
                )

        if query_filter is not None:
            if sort is not None:
                if isinstance(sort, str):
                    if limit is not None:
                        resultset = (
                            getattr(self, "store_{}".format(retrieve))
                            .find(dict_filter, query_filter)
                            .sort(sort, DESCENDING)
                            .limit(limit)
                            .skip(skip)
                        )
                    else:
                        resultset = (
                            getattr(self, "store_{}".format(retrieve))
                            .find(dict_filter, query_filter)
                            .sort(sort, DESCENDING)
                            .skip(skip)
                        )
                if isinstance(sort, list):
                    if limit is not None:
                        resultset = (
                            getattr(self, "store_{}".format(retrieve))
                            .find(dict_filter, query_filter)
                            .sort(sort)
                            .limit(limit)
                            .skip(skip)
                        )
                    else:
                        resultset = (
                            getattr(self, "store_{}".format(retrieve))
                            .find(dict_filter, query_filter)
                            .sort(sort)
                            .skip(skip)
                        )
            else:
                if limit is not None:
                    resultset = (
                        getattr(self, "store_{}".format(retrieve))
                        .find(dict_filter, query_filter)
                        .limit(limit)
                        .skip(skip)
                    )
                else:
                    resultset = (
                        getattr(self, "store_{}".format(retrieve))
                        .find(dict_filter, query_filter)
                        .skip(skip)
                    )

        if id_to_string:
            for doc in resultset:
                doc["_id"] = str(doc["_id"])
                documentlist.append(doc)
        else:
            for doc in resultset:
                documentlist.append(doc)

        return documentlist

    def fetch_one(
        self, retrieve=None, dict_filter={}, query_filter=None, id_to_string=True
    ):
        """
        The fetch one method wraps the original find_one method from pyMongo and turns the _id into a string.

        :param retrieve: Collection name where to retrieve the documents from
        :type retrieve: str
        :param dict_filter: dict representing a filter see pyMongo doc
        :type dict_filter: dict
        :param query_filter: Dict with fields to exclude or include; e.g. {"hosts": 0} or {"hosts": 1}
        :type query_filter: dict
        :param id_to_string: Whether to convert mongodb '_id' from an ObjectId to a string
        :type id_to_string: bool
        :return: Dict with items from database or None
        :rtype: dict or None
        """

        if "_id" in dict_filter:
            if isinstance(dict_filter["_id"], str):
                dict_filter["_id"] = bson.objectid.ObjectId(dict_filter["_id"])
        if query_filter is not None:
            result = getattr(self, "store_{}".format(retrieve)).find_one(
                dict_filter, query_filter
            )
        else:
            result = getattr(self, "store_{}".format(retrieve)).find_one(dict_filter)

        if result is not None:
            if id_to_string:
                result["_id"] = str(result["_id"])

        return result
