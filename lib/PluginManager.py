#!/usr/bin/env python3.3
# -*- coding: utf-8 -*-
#
# Plugin manager
#
# Software is free software released under the "Modified BSD license"
#
# Copyright (c) 2016 	Pieter-Jan Moreels - pieterjan.moreels@gmail.com

# Imports
import sys
import os
runPath = os.path.dirname(os.path.realpath(__file__))
sys.path.append(os.path.join(runPath, ".."))

import importlib

from lib.Config import Configuration as conf
from lib.Config import ConfigReader
from lib.Plugins import Plugin, WebPlugin
from flask.ext.login import current_user

class PluginManager():
  def __init__(self):
    self.plugins = {}
  
  def loadPlugins(self):
    settingsReader = ConfigReader(conf.getPluginsettings())
    if not os.path.exists(conf.getPluginLoadSettings()):
        print("[!] Could not find plugin loader file!")
        return
    # Read and parse plugin file
    data = open(conf.getPluginLoadSettings(), "r").read()
    data = [x.split("\t") for x in data.split("\n") if not x.startswith("#") and x]
    data = [[x.strip() for x in y if x.strip()] for y in data]
    uids = []
    for x in [x for x in data if len(x) == 2]:
      try:
        if x[1].lower() == "load" or x[1].lower() == "default":
          # Load plugins
          i = importlib.import_module(x[0].replace("/", "."))
          plugin = getattr(i, x[0].split("/")[-1])()
          plugin.setUID(plugin.getName().replace(" ", "_"))
          # Ensure UID's unique
          while True:
            if plugin.getUID() in uids: plugin.setUID(plugin.getUID()+"_")
            else: break
          # Load settings if needed
          if x[1].lower() == "load":
            plugin.loadSettings(settingsReader)
          # Add to list
          self.plugins[plugin.getUID().strip()] = plugin
          print("[+] Loaded plugin %s"%x[0])
      except Exception as e:
        print("[!] Failed to load module %s: "%x[0])
        print("[!]  -> %s"%e)

  def onOpenCVE(self, cve, user):
    for plugin in self.plugins.values(): # Read all plugins
      if plugin.isWebPlugin():           # Check if plugin is web plugin
        return plugin.onJsonCall(action, **args)

  def onCVEAction(self, cve, plugin, action, **args):
    if plugin.strip() in self.plugins.keys(): # Check if plugin exists
      if self.plugins[plugin].isWebPlugin():  # Check if plugin is web plugin
        return self.plugins[plugin].onCVEAction(cve, action, **args)

  def getPlugins(self):
    return self.plugins.values()

  def getWebPlugins(self):
    webPlugins = []
    for plugin in self.plugins.values():
      if plugin.isWebPlugin():
        webPlugins.append(plugin)
    return webPlugins

  def getWebPluginsWithPage(self):
    plugins = []
    for plug in self.getWebPlugins:
      page = plug.getPage()
      if page and page[0]: # Make sure there is a page
        plugins.append(plug)
    return plugins

  def getCVEActions(self, **args):
    actions = []
    for plugin in self.getWebPlugins():
      auth = plugin.requiresAuth
      for action in plugin.getCVEActions(**args):
        action['auth'] = auth
        action['plugin'] = plugin.getUID()
        actions.append(action)
    return actions

  def requiresAuth(self, plugin):
    if plugin.strip() in self.plugins.keys(): # Check if plugin exists
      return self.plugins[plugin].requiresAuth
    else: return False

  def openPage(self, name, **args):
    if name.strip() in self.plugins.keys(): # Check if plugin exists
      if self.plugins[name].isWebPlugin():  # Check if plugin is web plugin
        pageInfo = self.plugins[name].getPage(**args)
        if type(pageInfo) == tuple:
          page, content = pageInfo
          if page: return ("plugins/%s"%page, content)
          else:    return None
        else:
          return ("error.html", {'status': {'except': 'plugin-page-missing'}})
    return ("error.html", {'status': {'except': 'plugin-not-loaded'}})
