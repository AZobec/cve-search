#!/usr/bin/env python3.3
# -*- coding: utf-8 -*-
#
# Whitelist feature to mark CVE's for CPE's of personal interest
#
# Software is free software released under the "Modified BSD license"
#

# Copyright (c) 2014      Pieter-Jan Moreels - pieterjan.moreels@gmail.com

# Imports
# make sure these modules are available on your system
import sys
import pymongo
import argparse
import re
import os

# parse command line arguments
argparser = argparse.ArgumentParser(description='populate/update the whitelist used in webviews')
argparser.add_argument('-a', action='append', help='add one or more CPE to whitelist')
argparser.add_argument('-r', action='append', help='remove one or more CPE from whitelist')
argparser.add_argument('-i', help='filename of the whitelist to import')
argparser.add_argument('-e', help='filename of the whitelist to export')
argparser.add_argument('-d', action='store_true', help='drop the whitelist')
argparser.add_argument('-f', action='store_true', help='force an action')
argparser.add_argument('-v', action='store_true', help='verbose output')
args = argparser.parse_args()

connect = pymongo.Connection()
db = connect.cvedb
collection = db.mgmt_whitelist

# check if db is filled
def countItems():
    return collection.count()

# check if a cpe is in the whitelist
def check(cpe):
    try:
        whitelistElement={'id': cpe}
        amount=collection.find(whitelistElement).count()
        return amount
    except Exception:
        print("Error connecting to the database")
        sys.exit()

# insert to database
def insert(cpe):
    try:
        cpe=cpe.strip()
        # check format
        if re.match("cpe:/", cpe):
            # already in db?
            if check(cpe)==0:
                if '#' in cpe:
                    # there are extra comments
                    cpeID = cpe.split('#')[0]
                    cpeID.strip()
                    # allow multiple comments
                    comments = cpe.split('#')
                    del comments[0]
                    whitelistElement={'id': cpeID, 'comments': comments}
                else:
                    whitelistElement={'id': cpe}
                collection.insert(whitelistElement)
                return True
        return False
    except Exception:
        print("Error inserting item in database")
        sys.exit()

def remove(cpe):
    try:
        cpe=cpe.strip()
        # check if the cpe is in the whitelist
        amount=check(cpe)
        if amount>0:
            whitelistElement={'id': cpe}
            collection.remove(whitelistElement)
        return amount
    except Exception:
        print("Error removing item from database")
        sys.exit()

def dropDb():
    try:
        count=countItems()
        collection.drop()
        if args.v:
            print("collection of {:d} items dropped".format(count))
    except Exception:
        print("Error dropping the database")
        sys.exit()

def importList(importFile):
    count=0
    # read each line from the import file and regex them to a cpe format
    try:
        for line in open(importFile):
            if insert(line):
                count+=1
        if args.v:
            print("{:d} products added to the whitelist".format(count))
    except IOError:
        print('Could not open the file')
        sys.exit()

def exportList(exportFile):
    count=0
    # check if file exists already
    if not os.path.exists(exportFile) or args.f:
        whitelisted = collection.find()
        export = open(exportFile,'w')
        for whitelistedID in whitelisted:
            count+=1
            commentString = ""
            # check if there are comments
            if 'comments' in whitelistedID:
                comments = whitelistedID['comments']
                # separate the comments
                for comment in comments:
                    commentString = commentString + '#' + comment
            export.write(whitelistedID['id']+commentString+'\n')
        export.close()
        if args.v:
            print("{:d} whitelisted items exported".format(count))
    else:
        print("file already exists")

if __name__=='__main__':
    if args.d:
        # drop the whitelist
        dropDb()
    elif args.i:
        # get import file
        textfile=args.i
        # check if the collection is empty
        count=countItems()
        if count>0 and args.f is False:
            # not empty and not forced to drop
            print("whitelist already populated")
        else:
            # drop collection and repopulate it
            dropDb()
            importList(textfile)
    elif args.e:
        # get export file
        textfile=args.e
        exportList(textfile)
    elif args.a:
        # get list of cpe's to add
        cpeList = args.a
        # add each item from the list
        count=0
        for cpeID in cpeList:
            if insert(cpeID):
                count+=1
        if args.v:
            print("{:d} products added to the whitelist".format(count))
    elif args.r:
        # get list of cpe's to remove
        cpeList=args.r
        # remove each item from the list
        count=0
        for cpeID in cpeList:
            amount=remove(cpeID)
            count+=amount
        if args.v:
            print("{:d} products removed from the whitelist".format(count))
