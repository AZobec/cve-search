#!/usr/bin/env python3
# -*- coding: utf-8 -*-
#
# Tool to dump in JSON the database along with the associated ranking
#
# Software is free software released under the "Modified BSD license"
#
# Copyright (c) 2012-2013 	Alexandre Dulaunoy - a@foo.be
# Copyright (c) 2015 		Pieter-Jan Moreels - pieterjan.moreels@gmail.com

# Import
import os
import sys
runPath = os.path.dirname(sys.argv[0])
sys.path.append(os.path.join(runPath, "./lib/"))

import pymongo

import argparse
import json
from bson import json_util
import configparser

import cves

# config
Config = configparser.ConfigParser()
Config.read(os.path.join(runPath, "./configuration.ini"))
# default config
mongoHost = 'localhost'
mongoPort = 27017
mongoDB = "cvedb"
# read config from file
if ("Host" in Config['Mongo']) and (Config.get("Mongo", "Host")!=""):
    mongoHost = Config.get("Mongo", "Host")
if ("Port" in Config['Mongo']) and (Config.get("Mongo", "Port")!=""):
    mongoPort = int(Config.get("Mongo", "Port"))
if ("DB" in Config['Mongo']) and (Config.get("Mongo", "DB")!=""):
    mongoDB = Config.get("Mongo", "DB")

# connect to db
connect = pymongo.MongoClient(mongoHost, mongoPort)
db = connect[mongoDB]
collection = db.cves

def dumpallcveid ():
    cveid = []
    for x in collection.find({}).sort('_id',1):
        cveid.append(x['id'])
    return cveid

argParser = argparse.ArgumentParser(description='Dump database in JSON format')
argParser.add_argument('-r', action='store_true', help='Include ranking value')
argParser.add_argument('-v', action='store_true', help='Include vfeed map')
args = argParser.parse_args()

if args.r:
    rankinglookup=True
else:
    rankinglookup=False

if args.v:
    vfeedlookup=True
else:
    vfeedlookup=False

l = cves.last(rankinglookup=rankinglookup, vfeedlookup=vfeedlookup)

for cveid in dumpallcveid():
    item = l.getcve(cveid=cveid)
    print (json.dumps(item, sort_keys=True, default=json_util.default))
