#!/usr/bin/env python3
# -*- coding: utf-8 -*-
#
# Importing CPE entries in a Redis database to improve lookup
#
# Until now, this part is only used by the web interface to improve response time
#
# Software is free software released under the "Modified BSD license"
#
# Copyright (c) 2014 		Alexandre Dulaunoy - a@foo.be
# Copyright (c) 2014-2015 	Pieter-Jan Moreels - pieterjan.moreels@gmail.com

# Imports
import os
import sys
runPath = os.path.dirname(os.path.realpath(__file__))

import pymongo
import redis

import configparser

# config
Config = configparser.ConfigParser()
Config.read(os.path.join(runPath, "./configuration.ini"))
# default config
redisHost = 'localhost'
redisPort = 6379
redisDB = 10
mongoHost = 'localhost'
mongoPort = 27017
mongoDB = "cvedb"
# read config from file
if ("Host" in Config['Redis']) and (Config.get("Redis", "Host")!=""):
    redisHost = Config.get("Redis", "Host")
if ("Port" in Config['Redis']) and (Config.get("Redis", "Port")!=""):
    redisPort = int(Config.get("Redis", "Port"))
if ("VendorsDB" in Config['Redis']) and (Config.get("Redis", "VendorsDB")!=""):
    redisDB = int(Config.get("Redis", "VendorsDB"))
if ("Host" in Config['Mongo']) and (Config.get("Mongo", "Host")!=""):
    mongoHost = Config.get("Mongo", "Host")
if ("Port" in Config['Mongo']) and (Config.get("Mongo", "Port")!=""):
    mongoPort = int(Config.get("Mongo", "Port"))
if ("DB" in Config['Mongo']) and (Config.get("Mongo", "DB")!=""):
    mongoDB = Config.get("Mongo", "DB")

# connect to db
connect = pymongo.MongoClient(mongoHost, mongoPort)
db = connect[mongoDB]
cpe = db.cpe

try:
    r = redis.StrictRedis(host=redisHost, port=redisPort, db=redisDB)
except:
    sys.exit(1)

for e in cpe.find({}):
    try:
        (prefix, cpetype, vendor, product, version) = e['id'].split(':')
    except:
        pass
    r.sadd("prefix:"+prefix, cpetype)
    r.sadd("t:"+cpetype, vendor)
    r.sadd("v:"+vendor, product)
    r.sadd("p:"+product, version)
