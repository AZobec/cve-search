#!/usr/bin/env python3
# -*- coding: utf-8 -*-
#
# Software is free software released under the "Modified BSD license"
#
# Copyright (c) 2014 	psychedelys
# Copyright (c) 2015 	Pieter-Jan Moreels - pieterjan.moreels@gmail.com

# Imports
import os
import sys
_runPath = os.path.dirname(sys.argv[0])

import pymongo

import re
import argparse
import json
import configparser

# config
Config = configparser.ConfigParser()
Config.read(os.path.join(_runPath, "./configuration.ini"))
# default config
mongoHost = 'localhost'
mongoPort = 27017
# read config from file
if ("Host" in Config['Mongo']) and (Config.get("Mongo", "Host")!=""):
    mongoHost = Config.get("Mongo", "Host")
if ("Port" in Config['Mongo']) and (Config.get("Mongo", "Port")!=""):
    mongoPort = int(Config.get("Mongo", "Port"))

# connect to DB
connect = pymongo.MongoClient(mongoHost,mongoPort)
db = connect.cvedb
collection = db.cpe

vOutput = ""

argParser = argparse.ArgumentParser( description='Search for CPE with a pattern')
argParser.add_argument('-s', type=str, help='search in cpe list')
argParser.add_argument('-o', type=str, help='O = output format [compact]')
argParser.add_argument('-f', action='store_true', help='Enlarge the CPE search to all CPE indexed. Need the cpeother activated.', default=False)

args = argParser.parse_args()
cpeSearch = args.s
vOutput = args.o

if not cpeSearch:
   print ("no option provided")
   argParser.print_help()
else:
   # replace special characters in cpeSearch with encoded version.
   cpeSearch = re.sub(r'\(','%28', cpeSearch)
   cpeSearch = re.sub(r'\)','%29', cpeSearch)

   res = collection.find({'id': {'$regex' :  re.compile(cpeSearch, re.IGNORECASE)}})
   res.count()

   if vOutput == "compact":
       for item in  res:
           print( item['id'] )
   else:
       for item in  res:
           print( item['id'] + "  " + item['title']  )

   if args.f:
       collection = db.cpeother
       res = collection.find({'id': {'$regex' :  re.compile(cpeSearch, re.IGNORECASE)}})
       res.count()
       if vOutput == "compact":
           for item in  res:
               print( item['id'] )
       else:
           for item in  res:
               print( item['id'] + "  " + item['title']  )

