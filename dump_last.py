from feedformatter import Feed
import pymongo

feed = Feed()

rankinglookup = True

connect = pymongo.Connection()
db = connect.cvedb
collection = db.cves

def lookupcpe(cpeid = None):
    e = db.cpe.find_one({'id': cpeid})
    if e is None:
        return cpeid
    if 'id' in e:
        return e['title']

def findranking(cpe = None, loosy = True):
    if cpe is None:
        return False
    r = db.ranking
    result = False
    if loosy:
        for x in cpe.split(':'):
            if x is not '':
                i = r.find_one({'cpe': {'$regex':x}})
            if i is None:
                continue
            if 'rank' in i:
                result = i['rank']
    else:
        i = r.find_one({'cpe': {'$regex':cpe}})
        print (cpe)
        if i is None:
            return result
        if 'rank' in i:
            result = i['rank']

    return result


def lastentries(limit = 5, namelookup=True):
    entries = []
    for item in collection.find({}).sort("last-modified",-1).limit(limit):
        if not namelookup:
            entries.append(item)
        else:
            if "vulnerable_configuration" in item:
                vulconf = []
                ranking = []
                for conf in item['vulnerable_configuration']:
                    vulconf.append(lookupcpe(cpeid=conf))
                    if rankinglookup:
                        rank = findranking(cpe=conf)
                        if rank and rank not in ranking:
                            ranking.append(rank)

                item['vulnerable_configuration'] = vulconf
                if rankinglookup:
                    item['ranking'] = ranking
            entries.append(item)
    return entries

print (lastentries())
